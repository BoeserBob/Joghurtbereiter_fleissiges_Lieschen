///////////// TAUPI 4.0 @ Shelly ///// Script Lüfter schalten /////////////////////////////
// copyright by boeserbob
// Fragen an quirb@web.de
// Dokumentation und aktuelle Versionen unter https://github.com/BoeserBob/Taupi-4.0
// Lizenz und erforderliche Firmware siehe in den Kommentaren des Scripts "taupi_event_handler_checkBlu"
//
// Dieser Script schaltet das Heizelement (über den Schalter des Shellys auf dem er installiert ist). 
//   er startet eine Timerschleife
//     die Timerschleife holt sich die erforderlichen Werte über Funktion aus dem KVS
// 
// Die Schaltparameter (Mindesttemperaturen, Maximaltemperaturen, ...) können in der Funktion "schalten" angepasst werden. 
//

function schalten(temperatur_innen) {
 print("schalten_aufgerufen ");

/////////////// Schaltparameter ///////////////
 let mindesttemperatur = 40; // in °C = unterhalb dieser Temperatur geheizt 
 let maxtemperatur = 42; // in °C = oberhalb dieser Schwelle wird nicht mehr geheizt
 let laufzeit = 36000 // Zeit in Sekunden
//////////// Schaltparameter /////////////////

Shelly.call("Shelly.GetStatus", {}, function (result) {
    let unixTime = result.sys.unixtime; // Unix-Zeit in Sekunden seit 1. Januar 1970
    print("Unix-Zeit: " + unixTime);
});


if (unixTime < unixtime + laufzeit) { // Laufzeitüberwachung

   if (temperatur_innen > maxtemperatur) { // Anfang Termperaturüberwachung
      print("ausschalten weil zu warm");
      Shelly.call("Switch.Set", {id:0, on:false});

      }
    else {
        if (temperatur_innen < mindesttemperatur) {
          print("Heizung einschalten ");
          Shelly.call("Switch.Set", {id:0, on:true}); 
        } else {
        print("Heizung aus da noch warm genug");
      Shelly.call("Switch.Set", {id:0, on:false});;
      }

    } // Ende Temperaturüberwachung
} // Ende Laufzeitüberwachung

} /// Ende Funktion schalten


function kvsGet(key1, key2) {  /// abholen der Temperatur und des Tastendrucks.
    Shelly.call(
        "KVS.get",
        { "key": key1 },
        function (result) {
        temp_innen = result.value;
        }
    );

    Shelly.call(
        "KVS.get",
        { "key": key2 },
        function (result) {
        startzeit = result.value;
        }
    );
        
} 

//kvsGet("temperatur_innen");
  let temp_innen;
  let startzeit;
  
Timer.set(6000, true, function(ud) { //Start Timerschleife alle 6000 Millisekunden
  kvsGet("temperatur_innen", "zeit_letzter_tastendruck");
  print(temp_innen);
  schalten(temp_innen, startzeit);
     
 } // Ende Timerschleife
 , null);
